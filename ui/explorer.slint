// Explorer component - bucket tree and file list

import { VerticalBox, HorizontalBox, ListView, LineEdit, ScrollView } from "std-widgets.slint";
import { FileListComponent, FileItem } from "file_list.slint";

export { FileItem }

export struct BucketItem {
    name: string,
    is-expanded: bool,
    is-selected: bool,
}

export component ExplorerComponent inherits HorizontalBox {
    // Bucket tree properties
    in-out property <[BucketItem]> buckets: [];
    in-out property <string> bucket-filter: "";
    in-out property <int> selected-bucket-index: -1;
    in-out property <string> current-prefix: "";

    // File list properties (passed through to FileListComponent)
    in-out property <[FileItem]> files: [];
    in-out property <string> file-current-path: "";
    in-out property <bool> file-is-loading: false;
    in-out property <string> file-prefix-filter: "";
    in-out property <string> file-search-filter: "";
    in-out property <int> file-selection-count: 0;
    in-out property <string> file-toast-message: "";
    in-out property <bool> file-show-toast: false;
    // New properties for enhanced error handling
    in-out property <string> file-toast-type: "info";
    in-out property <bool> file-show-delete-confirm: false;
    in-out property <int> file-delete-count: 0;
    in-out property <string> file-loading-status: "";

    // Bucket tree callbacks
    callback bucket-selected(int);
    callback bucket-filter-changed(string);

    // File list callbacks
    callback file-selected(int);
    callback file-selected-with-ctrl(int, bool);
    callback file-double-clicked(int);
    callback prefix-filter-changed(string);
    callback search-filter-changed(string);
    callback navigate-up();
    callback copy-url-clicked();
    callback download-clicked();
    callback upload-clicked();
    callback delete-clicked();
    callback delete-confirmed();
    callback delete-cancelled();
    callback rename-clicked();
    callback cancel-loading();

    // Left panel - bucket tree
    VerticalBox {
        width: 250px;
        padding: 4px;

        // Bucket filter
        LineEdit {
            placeholder-text: "Filter buckets...";
            text <=> bucket-filter;
            edited(text) => {
                bucket-filter-changed(text);
            }
        }

        // Bucket list
        ScrollView {
            vertical-stretch: 1;

            VerticalBox {
                for bucket[index] in buckets: Rectangle {
                    height: 28px;
                    background: bucket.is-selected ? #e0e0ff : (touch.has-hover ? #f0f0f0 : transparent);
                    border-radius: 4px;

                    touch := TouchArea {
                        clicked => {
                            bucket-selected(index);
                        }
                    }

                    HorizontalBox {
                        padding-left: 8px;
                        padding-right: 8px;

                        Text {
                            text: "ðŸ“";
                            font-size: 14px;
                            vertical-alignment: center;
                        }

                        Text {
                            text: bucket.name;
                            font-size: 14px;
                            color: #333333;
                            vertical-alignment: center;
                            overflow: elide;
                        }
                    }
                }
            }
        }
    }

    // Divider
    Rectangle {
        width: 1px;
        background: #cccccc;
    }

    // Right panel - file list
    FileListComponent {
        horizontal-stretch: 1;
        files: root.files;
        current-path: root.file-current-path;
        is-loading: root.file-is-loading;
        prefix-filter: root.file-prefix-filter;
        search-filter: root.file-search-filter;
        selection-count: root.file-selection-count;
        toast-message: root.file-toast-message;
        show-toast: root.file-show-toast;
        toast-type: root.file-toast-type;
        show-delete-confirm: root.file-show-delete-confirm;
        delete-count: root.file-delete-count;
        loading-status: root.file-loading-status;

        file-selected(index) => {
            root.file-selected(index);
        }
        file-selected-with-ctrl(index, ctrl) => {
            root.file-selected-with-ctrl(index, ctrl);
        }
        file-double-clicked(index) => {
            root.file-double-clicked(index);
        }
        prefix-filter-changed(text) => {
            root.prefix-filter-changed(text);
        }
        search-filter-changed(text) => {
            root.search-filter-changed(text);
        }
        navigate-up() => {
            root.navigate-up();
        }
        copy-url-clicked() => {
            root.copy-url-clicked();
        }
        download-clicked() => {
            root.download-clicked();
        }
        upload-clicked() => {
            root.upload-clicked();
        }
        delete-clicked() => {
            root.delete-clicked();
        }
        delete-confirmed() => {
            root.delete-confirmed();
        }
        delete-cancelled() => {
            root.delete-cancelled();
        }
        rename-clicked() => {
            root.rename-clicked();
        }
        cancel-loading() => {
            root.cancel-loading();
        }
    }
}
