// S3 Browser Main Window

import { Button, VerticalBox, HorizontalBox, ListView, ComboBox, LineEdit, StandardButton } from "std-widgets.slint";
import { ExplorerComponent, BucketItem } from "explorer.slint";
import { FileItem } from "file_list.slint";
import { ParquetViewerDialog, ParquetColumn, ParquetRow, ParquetCell } from "dialogs/parquet_viewer.slint";
import { CsvViewerDialog, CsvColumn, CsvRow, CsvCell } from "dialogs/csv_viewer.slint";
import { ImageViewerDialog } from "dialogs/image_viewer.slint";
import { TextEditorDialog } from "dialogs/text_editor.slint";
import { JsonViewerDialog, JsonTreeNode } from "dialogs/json_viewer.slint";

// Re-export structs for Rust access
export { BucketItem, FileItem, ParquetColumn, ParquetRow, ParquetCell, CsvColumn, CsvRow, CsvCell, JsonTreeNode }

// Global state for Explorer - allows Rust to access explorer data
export global Explorer {
    in-out property <[BucketItem]> buckets: [];
    in-out property <string> bucket-filter: "";
    in-out property <int> selected-bucket-index: -1;
    in-out property <string> current-prefix: "";

    callback bucket-selected(int);
    callback bucket-filter-changed(string);
}

// Global state for FileList - allows Rust to access file list data
export global FileList {
    in-out property <[FileItem]> files: [];
    in-out property <string> prefix-filter: "";
    in-out property <string> search-filter: "";
    in-out property <string> current-path: "";
    in-out property <bool> is-loading: false;
    in-out property <int> selection-count: 0;
    in-out property <string> toast-message: "";
    in-out property <bool> show-toast: false;
    // Toast type: "info", "success", "error"
    in-out property <string> toast-type: "info";
    // Delete confirmation
    in-out property <bool> show-delete-confirm: false;
    in-out property <int> delete-count: 0;
    // Loading progress/status
    in-out property <string> loading-status: "";

    callback file-selected(int);
    callback file-selected-with-ctrl(int, bool);
    callback file-double-clicked(int);
    callback prefix-filter-changed(string);
    callback search-filter-changed(string);
    callback navigate-up();
    callback copy-url-clicked();
    callback download-clicked();
    callback upload-clicked();
    callback delete-clicked();
    callback delete-confirmed();
    callback delete-cancelled();
    callback rename-clicked();
    callback cancel-loading();
}

// Global state for Parquet Viewer - allows Rust to control the viewer
export global ParquetViewer {
    in-out property <string> file-name: "";
    in-out property <[ParquetColumn]> columns: [];
    in-out property <[ParquetRow]> rows: [];
    in-out property <int> total-rows: 0;
    in-out property <int> loaded-rows: 0;
    in-out property <bool> is-loading: false;
    in-out property <bool> dialog-visible: false;

    callback close-requested();
    callback load-more-requested();
}

// Global state for CSV Viewer - allows Rust to control the viewer
export global CsvViewer {
    in-out property <string> file-name: "";
    in-out property <[CsvColumn]> columns: [];
    in-out property <[CsvRow]> rows: [];
    in-out property <int> total-rows: 0;
    in-out property <int> loaded-rows: 0;
    in-out property <bool> is-loading: false;
    in-out property <bool> has-more: false;
    in-out property <bool> dialog-visible: false;

    callback close-requested();
    callback load-more-requested();
}

// Global state for Image Viewer - allows Rust to control the viewer
export global ImageViewer {
    in-out property <string> file-name: "";
    in-out property <image> image-data;
    in-out property <int> image-width: 0;
    in-out property <int> image-height: 0;
    in-out property <string> file-size: "";
    in-out property <string> format-name: "";
    in-out property <bool> is-loading: false;
    in-out property <bool> dialog-visible: false;

    callback close-requested();
}

// Global state for Text Editor - allows Rust to control the editor
export global TextEditor {
    in-out property <string> file-name: "";
    in-out property <string> content: "";
    in-out property <string> syntax-type: "Plain Text";
    in-out property <string> file-size: "";
    in-out property <int> line-count: 0;
    in-out property <bool> read-only: false;
    in-out property <bool> is-loading: false;
    in-out property <bool> is-saving: false;
    in-out property <bool> is-modified: false;
    in-out property <bool> dialog-visible: false;

    callback close-requested();
    callback save-requested(string);
    callback content-changed(string);
}

// Global state for JSON Viewer - allows Rust to control the viewer
export global JsonViewer {
    in-out property <string> file-name: "";
    in-out property <[JsonTreeNode]> tree-nodes: [];
    in-out property <string> text-content: "";
    in-out property <int> total-nodes: 0;
    in-out property <string> file-size: "";
    in-out property <bool> is-valid: true;
    in-out property <string> error-message: "";
    in-out property <bool> is-loading: false;
    in-out property <bool> dialog-visible: false;
    in-out property <bool> show-tree-view: true;

    callback close-requested();
    callback node-toggle-requested(string);
    callback expand-all-requested();
    callback collapse-all-requested();
}

export component MainWindow inherits Window {
    title: "S3 Browser";
    min-width: 1024px;
    min-height: 768px;
    preferred-width: 1280px;
    preferred-height: 800px;

    // Profile selection
    in-out property <[string]> profiles: ["default"];
    in-out property <int> current-profile-index: 0;
    in-out property <string> status-message: "Ready";
    in-out property <bool> is-loading: false;
    // Error state
    in-out property <bool> is-error: false;
    in-out property <string> error-title: "";
    in-out property <string> error-details: "";
    in-out property <bool> show-error-dialog: false;

    // Callbacks
    callback profile-changed(int);
    callback navigate-to-url(string);
    callback refresh-requested();
    callback cancel-loading();
    callback dismiss-error();

    VerticalBox {
        // Toolbar
        HorizontalBox {
            height: 40px;
            padding: 4px;
            spacing: 8px;

            Text {
                text: "Profile:";
                vertical-alignment: center;
            }

            profile-combo := ComboBox {
                model: profiles;
                current-index <=> current-profile-index;
                selected(value) => {
                    profile-changed(profile-combo.current-index);
                }
            }

            Rectangle {
                width: 16px;
            }

            Text {
                text: "Go to:";
                vertical-alignment: center;
            }

            url-input := LineEdit {
                placeholder-text: "s3://bucket/path or https://...";
                horizontal-stretch: 1;
                accepted(text) => {
                    navigate-to-url(text);
                }
            }

            Button {
                text: "Go";
                clicked => {
                    navigate-to-url(url-input.text);
                }
            }

            Button {
                text: "↻";
                width: 32px;
                clicked => {
                    refresh-requested();
                }
            }
        }

        // Main content
        explorer := ExplorerComponent {
            vertical-stretch: 1;
            buckets: Explorer.buckets;
            bucket-filter: Explorer.bucket-filter;
            selected-bucket-index: Explorer.selected-bucket-index;
            current-prefix: Explorer.current-prefix;

            bucket-selected(index) => {
                Explorer.bucket-selected(index);
            }
            bucket-filter-changed(text) => {
                Explorer.bucket-filter-changed(text);
            }

            // Pass file list state to embedded file list
            files: FileList.files;
            file-current-path: FileList.current-path;
            file-is-loading: FileList.is-loading;
            file-prefix-filter: FileList.prefix-filter;
            file-search-filter: FileList.search-filter;
            file-selection-count: FileList.selection-count;
            file-toast-message: FileList.toast-message;
            file-show-toast: FileList.show-toast;
            file-toast-type: FileList.toast-type;
            file-show-delete-confirm: FileList.show-delete-confirm;
            file-delete-count: FileList.delete-count;
            file-loading-status: FileList.loading-status;

            file-selected(index) => {
                FileList.file-selected(index);
            }
            file-selected-with-ctrl(index, ctrl) => {
                FileList.file-selected-with-ctrl(index, ctrl);
            }
            file-double-clicked(index) => {
                FileList.file-double-clicked(index);
            }
            prefix-filter-changed(text) => {
                FileList.prefix-filter-changed(text);
            }
            search-filter-changed(text) => {
                FileList.search-filter-changed(text);
            }
            navigate-up() => {
                FileList.navigate-up();
            }
            copy-url-clicked() => {
                FileList.copy-url-clicked();
            }
            download-clicked() => {
                FileList.download-clicked();
            }
            upload-clicked() => {
                FileList.upload-clicked();
            }
            delete-clicked() => {
                FileList.delete-clicked();
            }
            delete-confirmed() => {
                FileList.delete-confirmed();
            }
            delete-cancelled() => {
                FileList.delete-cancelled();
            }
            rename-clicked() => {
                FileList.rename-clicked();
            }
            cancel-loading() => {
                FileList.cancel-loading();
            }
        }

        // Status bar
        HorizontalBox {
            height: 24px;
            padding: 4px;

            // Status icon based on error state
            if is-error: Text {
                text: "⚠";
                color: #cc0000;
                font-size: 14px;
                vertical-alignment: center;
            }

            Text {
                text: status-message;
                color: is-error ? #cc0000 : #666666;
                font-size: 12px;
            }

            Rectangle {
                horizontal-stretch: 1;
            }

            if is-loading: HorizontalBox {
                spacing: 8px;

                Text {
                    text: "Loading...";
                    color: #666666;
                    font-size: 12px;
                    vertical-alignment: center;
                }

                Button {
                    text: "Cancel";
                    height: 20px;
                    clicked => {
                        cancel-loading();
                    }
                }
            }
        }
    }

    // Error dialog overlay
    if show-error-dialog: Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: #00000080;

        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 500px;
            height: 250px;
            background: white;
            border-radius: 8px;
            drop-shadow-blur: 16px;
            drop-shadow-color: #00000040;

            VerticalBox {
                padding: 20px;
                spacing: 16px;

                // Error header
                HorizontalBox {
                    height: 32px;
                    spacing: 12px;

                    Text {
                        text: "⚠";
                        color: #cc0000;
                        font-size: 24px;
                        vertical-alignment: center;
                    }

                    Text {
                        text: error-title;
                        color: #333333;
                        font-size: 18px;
                        font-weight: 600;
                        vertical-alignment: center;
                    }

                    Rectangle {
                        horizontal-stretch: 1;
                    }
                }

                // Error details
                Rectangle {
                    vertical-stretch: 1;
                    background: #f5f5f5;
                    border-radius: 4px;

                    Text {
                        x: 12px;
                        y: 12px;
                        width: parent.width - 24px;
                        text: error-details;
                        color: #666666;
                        font-size: 13px;
                        wrap: word-wrap;
                    }
                }

                // Dismiss button
                HorizontalBox {
                    height: 36px;

                    Rectangle {
                        horizontal-stretch: 1;
                    }

                    Button {
                        text: "Dismiss";
                        clicked => {
                            dismiss-error();
                        }
                    }
                }
            }
        }
    }

    // Parquet Viewer Dialog (overlay)
    ParquetViewerDialog {
        file-name: ParquetViewer.file-name;
        columns: ParquetViewer.columns;
        rows: ParquetViewer.rows;
        total-rows: ParquetViewer.total-rows;
        loaded-rows: ParquetViewer.loaded-rows;
        is-loading: ParquetViewer.is-loading;
        dialog-visible: ParquetViewer.dialog-visible;

        close-clicked => {
            ParquetViewer.close-requested();
        }
        load-more-clicked => {
            ParquetViewer.load-more-requested();
        }
    }

    // CSV Viewer Dialog (overlay)
    CsvViewerDialog {
        file-name: CsvViewer.file-name;
        columns: CsvViewer.columns;
        rows: CsvViewer.rows;
        total-rows: CsvViewer.total-rows;
        loaded-rows: CsvViewer.loaded-rows;
        is-loading: CsvViewer.is-loading;
        has-more: CsvViewer.has-more;
        dialog-visible: CsvViewer.dialog-visible;

        close-clicked => {
            CsvViewer.close-requested();
        }
        load-more-clicked => {
            CsvViewer.load-more-requested();
        }
    }

    // Image Viewer Dialog (overlay)
    ImageViewerDialog {
        file-name: ImageViewer.file-name;
        image-data: ImageViewer.image-data;
        image-width: ImageViewer.image-width;
        image-height: ImageViewer.image-height;
        file-size: ImageViewer.file-size;
        format-name: ImageViewer.format-name;
        is-loading: ImageViewer.is-loading;
        dialog-visible: ImageViewer.dialog-visible;

        close-clicked => {
            ImageViewer.close-requested();
        }
    }

    // Text Editor Dialog (overlay)
    TextEditorDialog {
        file-name: TextEditor.file-name;
        content: TextEditor.content;
        syntax-type: TextEditor.syntax-type;
        file-size: TextEditor.file-size;
        line-count: TextEditor.line-count;
        read-only: TextEditor.read-only;
        is-loading: TextEditor.is-loading;
        is-saving: TextEditor.is-saving;
        is-modified: TextEditor.is-modified;
        dialog-visible: TextEditor.dialog-visible;

        close-clicked => {
            TextEditor.close-requested();
        }
        save-clicked(text) => {
            TextEditor.save-requested(text);
        }
        content-changed(text) => {
            TextEditor.content-changed(text);
        }
    }

    // JSON Viewer Dialog (overlay)
    JsonViewerDialog {
        file-name: JsonViewer.file-name;
        tree-nodes: JsonViewer.tree-nodes;
        text-content: JsonViewer.text-content;
        total-nodes: JsonViewer.total-nodes;
        file-size: JsonViewer.file-size;
        is-valid: JsonViewer.is-valid;
        error-message: JsonViewer.error-message;
        is-loading: JsonViewer.is-loading;
        dialog-visible: JsonViewer.dialog-visible;
        show-tree-view: JsonViewer.show-tree-view;

        close-clicked => {
            JsonViewer.close-requested();
        }
        node-toggle-clicked(node-id) => {
            JsonViewer.node-toggle-requested(node-id);
        }
        expand-all-clicked => {
            JsonViewer.expand-all-requested();
        }
        collapse-all-clicked => {
            JsonViewer.collapse-all-requested();
        }
    }

    // Delete confirmation dialog overlay
    if FileList.show-delete-confirm: Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: #00000060;

        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 400px;
            height: 180px;
            background: white;
            border-radius: 8px;
            drop-shadow-blur: 12px;
            drop-shadow-color: #00000040;

            VerticalBox {
                padding: 20px;
                spacing: 16px;

                // Warning header
                HorizontalBox {
                    height: 28px;
                    spacing: 10px;

                    Text {
                        text: "⚠";
                        color: #e65100;
                        font-size: 22px;
                        vertical-alignment: center;
                    }

                    Text {
                        text: "Confirm Delete";
                        color: #333333;
                        font-size: 16px;
                        font-weight: 600;
                        vertical-alignment: center;
                    }
                }

                // Confirmation message
                Text {
                    text: FileList.delete-count == 1 ? "Are you sure you want to delete 1 item? This action cannot be undone." : "Are you sure you want to delete " + FileList.delete-count + " items? This action cannot be undone.";
                    color: #666666;
                    font-size: 13px;
                    wrap: word-wrap;
                    vertical-stretch: 1;
                }

                // Action buttons
                HorizontalBox {
                    height: 36px;
                    spacing: 12px;

                    Rectangle {
                        horizontal-stretch: 1;
                    }

                    Button {
                        text: "Cancel";
                        clicked => {
                            FileList.delete-cancelled();
                        }
                    }

                    delete-btn := Rectangle {
                        width: 80px;
                        background: delete-touch.has-hover ? #d32f2f : #c62828;
                        border-radius: 4px;

                        delete-touch := TouchArea {
                            clicked => {
                                FileList.delete-confirmed();
                            }
                        }

                        Text {
                            text: "Delete";
                            color: white;
                            font-size: 13px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }
}
