// S3 Browser Main Window

import { Button, VerticalBox, HorizontalBox, ListView, ComboBox, LineEdit, StandardButton } from "std-widgets.slint";
import { ExplorerComponent, BucketItem } from "explorer.slint";
import { FileItem } from "file_list.slint";
import { ParquetViewerDialog, ParquetColumn, ParquetRow, ParquetCell } from "dialogs/parquet_viewer.slint";
import { CsvViewerDialog, CsvColumn, CsvRow, CsvCell } from "dialogs/csv_viewer.slint";
import { ImageViewerDialog } from "dialogs/image_viewer.slint";
import { TextEditorDialog } from "dialogs/text_editor.slint";

// Re-export structs for Rust access
export { BucketItem, FileItem, ParquetColumn, ParquetRow, ParquetCell, CsvColumn, CsvRow, CsvCell }

// Global state for Explorer - allows Rust to access explorer data
export global Explorer {
    in-out property <[BucketItem]> buckets: [];
    in-out property <string> bucket-filter: "";
    in-out property <int> selected-bucket-index: -1;
    in-out property <string> current-prefix: "";

    callback bucket-selected(int);
    callback bucket-filter-changed(string);
}

// Global state for FileList - allows Rust to access file list data
export global FileList {
    in-out property <[FileItem]> files: [];
    in-out property <string> prefix-filter: "";
    in-out property <string> search-filter: "";
    in-out property <string> current-path: "";
    in-out property <bool> is-loading: false;
    in-out property <int> selection-count: 0;
    in-out property <string> toast-message: "";
    in-out property <bool> show-toast: false;

    callback file-selected(int);
    callback file-selected-with-ctrl(int, bool);
    callback file-double-clicked(int);
    callback prefix-filter-changed(string);
    callback search-filter-changed(string);
    callback navigate-up();
    callback copy-url-clicked();
    callback download-clicked();
    callback upload-clicked();
    callback delete-clicked();
    callback rename-clicked();
}

// Global state for Parquet Viewer - allows Rust to control the viewer
export global ParquetViewer {
    in-out property <string> file-name: "";
    in-out property <[ParquetColumn]> columns: [];
    in-out property <[ParquetRow]> rows: [];
    in-out property <int> total-rows: 0;
    in-out property <int> loaded-rows: 0;
    in-out property <bool> is-loading: false;
    in-out property <bool> dialog-visible: false;

    callback close-requested();
    callback load-more-requested();
}

// Global state for CSV Viewer - allows Rust to control the viewer
export global CsvViewer {
    in-out property <string> file-name: "";
    in-out property <[CsvColumn]> columns: [];
    in-out property <[CsvRow]> rows: [];
    in-out property <int> total-rows: 0;
    in-out property <int> loaded-rows: 0;
    in-out property <bool> is-loading: false;
    in-out property <bool> has-more: false;
    in-out property <bool> dialog-visible: false;

    callback close-requested();
    callback load-more-requested();
}

// Global state for Image Viewer - allows Rust to control the viewer
export global ImageViewer {
    in-out property <string> file-name: "";
    in-out property <image> image-data;
    in-out property <int> image-width: 0;
    in-out property <int> image-height: 0;
    in-out property <string> file-size: "";
    in-out property <string> format-name: "";
    in-out property <bool> is-loading: false;
    in-out property <bool> dialog-visible: false;

    callback close-requested();
}

// Global state for Text Editor - allows Rust to control the editor
export global TextEditor {
    in-out property <string> file-name: "";
    in-out property <string> content: "";
    in-out property <string> syntax-type: "Plain Text";
    in-out property <string> file-size: "";
    in-out property <int> line-count: 0;
    in-out property <bool> read-only: false;
    in-out property <bool> is-loading: false;
    in-out property <bool> is-saving: false;
    in-out property <bool> is-modified: false;
    in-out property <bool> dialog-visible: false;

    callback close-requested();
    callback save-requested(string);
    callback content-changed(string);
}

export component MainWindow inherits Window {
    title: "S3 Browser";
    min-width: 1024px;
    min-height: 768px;
    preferred-width: 1280px;
    preferred-height: 800px;

    // Profile selection
    in-out property <[string]> profiles: ["default"];
    in-out property <int> current-profile-index: 0;
    in-out property <string> status-message: "Ready";
    in-out property <bool> is-loading: false;

    // Callbacks
    callback profile-changed(int);
    callback navigate-to-url(string);
    callback refresh-requested();

    VerticalBox {
        // Toolbar
        HorizontalBox {
            height: 40px;
            padding: 4px;
            spacing: 8px;

            Text {
                text: "Profile:";
                vertical-alignment: center;
            }

            profile-combo := ComboBox {
                model: profiles;
                current-index <=> current-profile-index;
                selected(value) => {
                    profile-changed(profile-combo.current-index);
                }
            }

            Rectangle {
                width: 16px;
            }

            Text {
                text: "Go to:";
                vertical-alignment: center;
            }

            url-input := LineEdit {
                placeholder-text: "s3://bucket/path or https://...";
                horizontal-stretch: 1;
                accepted(text) => {
                    navigate-to-url(text);
                }
            }

            Button {
                text: "Go";
                clicked => {
                    navigate-to-url(url-input.text);
                }
            }

            Button {
                text: "â†»";
                width: 32px;
                clicked => {
                    refresh-requested();
                }
            }
        }

        // Main content
        explorer := ExplorerComponent {
            vertical-stretch: 1;
            buckets: Explorer.buckets;
            bucket-filter: Explorer.bucket-filter;
            selected-bucket-index: Explorer.selected-bucket-index;
            current-prefix: Explorer.current-prefix;

            bucket-selected(index) => {
                Explorer.bucket-selected(index);
            }
            bucket-filter-changed(text) => {
                Explorer.bucket-filter-changed(text);
            }

            // Pass file list state to embedded file list
            files: FileList.files;
            file-current-path: FileList.current-path;
            file-is-loading: FileList.is-loading;
            file-prefix-filter: FileList.prefix-filter;
            file-search-filter: FileList.search-filter;
            file-selection-count: FileList.selection-count;
            file-toast-message: FileList.toast-message;
            file-show-toast: FileList.show-toast;

            file-selected(index) => {
                FileList.file-selected(index);
            }
            file-selected-with-ctrl(index, ctrl) => {
                FileList.file-selected-with-ctrl(index, ctrl);
            }
            file-double-clicked(index) => {
                FileList.file-double-clicked(index);
            }
            prefix-filter-changed(text) => {
                FileList.prefix-filter-changed(text);
            }
            search-filter-changed(text) => {
                FileList.search-filter-changed(text);
            }
            navigate-up() => {
                FileList.navigate-up();
            }
            copy-url-clicked() => {
                FileList.copy-url-clicked();
            }
            download-clicked() => {
                FileList.download-clicked();
            }
            upload-clicked() => {
                FileList.upload-clicked();
            }
            delete-clicked() => {
                FileList.delete-clicked();
            }
            rename-clicked() => {
                FileList.rename-clicked();
            }
        }

        // Status bar
        HorizontalBox {
            height: 24px;
            padding: 4px;

            Text {
                text: status-message;
                color: #666666;
                font-size: 12px;
            }

            Rectangle {
                horizontal-stretch: 1;
            }

            if is-loading: Text {
                text: "Loading...";
                color: #666666;
                font-size: 12px;
            }
        }
    }

    // Parquet Viewer Dialog (overlay)
    ParquetViewerDialog {
        file-name: ParquetViewer.file-name;
        columns: ParquetViewer.columns;
        rows: ParquetViewer.rows;
        total-rows: ParquetViewer.total-rows;
        loaded-rows: ParquetViewer.loaded-rows;
        is-loading: ParquetViewer.is-loading;
        dialog-visible: ParquetViewer.dialog-visible;

        close-clicked => {
            ParquetViewer.close-requested();
        }
        load-more-clicked => {
            ParquetViewer.load-more-requested();
        }
    }

    // CSV Viewer Dialog (overlay)
    CsvViewerDialog {
        file-name: CsvViewer.file-name;
        columns: CsvViewer.columns;
        rows: CsvViewer.rows;
        total-rows: CsvViewer.total-rows;
        loaded-rows: CsvViewer.loaded-rows;
        is-loading: CsvViewer.is-loading;
        has-more: CsvViewer.has-more;
        dialog-visible: CsvViewer.dialog-visible;

        close-clicked => {
            CsvViewer.close-requested();
        }
        load-more-clicked => {
            CsvViewer.load-more-requested();
        }
    }

    // Image Viewer Dialog (overlay)
    ImageViewerDialog {
        file-name: ImageViewer.file-name;
        image-data: ImageViewer.image-data;
        image-width: ImageViewer.image-width;
        image-height: ImageViewer.image-height;
        file-size: ImageViewer.file-size;
        format-name: ImageViewer.format-name;
        is-loading: ImageViewer.is-loading;
        dialog-visible: ImageViewer.dialog-visible;

        close-clicked => {
            ImageViewer.close-requested();
        }
    }

    // Text Editor Dialog (overlay)
    TextEditorDialog {
        file-name: TextEditor.file-name;
        content: TextEditor.content;
        syntax-type: TextEditor.syntax-type;
        file-size: TextEditor.file-size;
        line-count: TextEditor.line-count;
        read-only: TextEditor.read-only;
        is-loading: TextEditor.is-loading;
        is-saving: TextEditor.is-saving;
        is-modified: TextEditor.is-modified;
        dialog-visible: TextEditor.dialog-visible;

        close-clicked => {
            TextEditor.close-requested();
        }
        save-clicked(text) => {
            TextEditor.save-requested(text);
        }
        content-changed(text) => {
            TextEditor.content-changed(text);
        }
    }
}
