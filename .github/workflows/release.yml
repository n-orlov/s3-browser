name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfontconfig1-dev libfreetype6-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev curl

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-

      - name: Run tests
        run: cargo test --all-features

      - name: Build release binary
        run: cargo build --release

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Create Linux tarball
        run: |
          mkdir -p dist
          tar -czvf dist/s3-browser-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz -C target/release s3-browser

      - name: Build AppImage
        run: |
          # Setup AppDir structure
          mkdir -p appimage/AppDir/usr/bin
          cp target/release/s3-browser appimage/AppDir/usr/bin/

          # Download AppImage runtime
          curl -L -o runtime-x86_64 "https://github.com/AppImage/AppImageKit/releases/download/continuous/runtime-x86_64"
          chmod +x runtime-x86_64

          # Download and extract appimagetool for mksquashfs
          curl -L -o appimagetool.AppImage "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool.AppImage
          ./appimagetool.AppImage --appimage-extract

          # Create squashfs and AppImage
          ./squashfs-root/usr/lib/appimagekit/mksquashfs appimage/AppDir/ appimage.squashfs -root-owned -noappend -comp gzip
          cat runtime-x86_64 appimage.squashfs > dist/S3-Browser-${{ steps.version.outputs.VERSION }}-x86_64.AppImage
          chmod +x dist/S3-Browser-${{ steps.version.outputs.VERSION }}-x86_64.AppImage

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            dist/s3-browser-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz
            dist/S3-Browser-${{ steps.version.outputs.VERSION }}-x86_64.AppImage
          retention-days: 1

  build-windows:
    name: Build Windows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-gnu

      - name: Install cross-compilation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mingw-w64-x86-64 zip

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-windows-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-windows-release-

      - name: Build Windows binary
        run: cargo build --release --target x86_64-pc-windows-gnu

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Create Windows portable zip
        run: |
          mkdir -p dist
          cd target/x86_64-pc-windows-gnu/release
          zip -9 ../../../dist/s3-browser-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip s3-browser.exe

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: dist/s3-browser-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip
          retention-days: 1

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-artifacts
          path: artifacts/

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-artifacts
          path: artifacts/

      - name: Create source tarball
        run: |
          git archive --format=tar.gz --prefix=s3-browser-${{ steps.version.outputs.VERSION }}/ -o artifacts/s3-browser-${{ steps.version.outputs.VERSION }}-source.tar.gz HEAD

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: S3 Browser v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/S3-Browser-${{ steps.version.outputs.VERSION }}-x86_64.AppImage
            artifacts/s3-browser-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz
            artifacts/s3-browser-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip
            artifacts/s3-browser-${{ steps.version.outputs.VERSION }}-source.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
